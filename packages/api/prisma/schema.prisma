generator client {
  provider = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Group {
  id                String              @id @default(uuid())
  type              String              @default("family")
  name              String
  code              String              @unique
  language          String              @default("fr")
  country           String?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  books             Book[]
  users             User[]
  categories        Category[]
  dailyMessages     DailyMessage[]
  evaluationWindows EvaluationWindow[]
  taskTemplates     TaskTemplate[]

  @@map("groups")
}

model Category {
  id            String         @id @default(uuid())
  title         String
  display       String
  description   String
  icon          String?
  isSystem      Boolean        @default(false)
  isActive      Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  groupId       String?
  group         Group?         @relation(fields: [groupId], references: [id], onDelete: Cascade)
  taskTemplates TaskTemplate[]

  @@unique([groupId, title], name: "category_group_title_unique", map: "category_group_title_unique")
  @@map("categories")
}

model User {
  id                 String              @id @default(uuid())
  role               String
  name               String
  email              String?             @unique
  password           String?
  age                Int?
  pin                String?
  avatar             String?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  groupId            String?
  theme              String              @default("default")
  lastLoginAt        DateTime?           // Nouveau champ pour tracking connexions
  totalPointsEarned  Int                 @default(0) // Nouveau champ pour optimiser les requêtes
  group              Group?              @relation(fields: [groupId], references: [id], onDelete: Cascade)
  bookLikes          BookLike[]
  bookReviews        BookReview[]
  dailyMessages      DailyMessage[]
  daySubmissions     DaySubmission[]
  evaluationWindows  EvaluationWindow[]
  assignedReadings   ReadingAssignment[] @relation("ReadingAssigner")
  readingAssignments ReadingAssignment[] @relation("ReadingChild")
  rewards            Reward[]
  assignments        TaskAssignment[]
  tasks              Task[]

  @@index([groupId, role], map: "idx_users_groupId_role")
  @@index([groupId, lastLoginAt], map: "idx_users_groupId_lastLoginAt")
  @@index([totalPointsEarned], map: "idx_users_totalPointsEarned")
  @@map("users")
}

model TaskTemplate {
  id          String           @id @default(uuid())
  categoryId  String
  title       String
  icon        String?
  points      Int              @default(5)
  recurrence  String
  description String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  groupId     String?
  group       Group?           @relation(fields: [groupId], references: [id], onDelete: Cascade)
  assignments TaskAssignment[]
  category    Category         @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  tasks       Task[]

  @@index([categoryId], map: "idx_task_templates_categoryId")
  @@map("task_templates")
}

model Task {
  id             String       @id @default(uuid())
  taskTemplateId String
  userId         String
  date           DateTime
  status         String       @default("assigned")
  selfScore      Int?
  parentScore    Int?
  parentComment  String?
  lockedAt       DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  taskTemplate   TaskTemplate @relation(fields: [taskTemplateId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, taskTemplateId, date])
  @@index([taskTemplateId], map: "idx_tasks_taskTemplateId")
  @@index([userId, date], map: "idx_tasks_userId_date")
  @@index([userId, date, selfScore], map: "idx_tasks_userId_date_score")
  @@map("tasks")
}

model DailyMessage {
  id        String   @id @default(uuid())
  childId   String?
  date      DateTime
  message   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  groupId   String?
  group     Group?   @relation(fields: [groupId], references: [id], onDelete: Cascade)
  child     User?    @relation(fields: [childId], references: [id])

  @@index([childId], map: "idx_daily_messages_childId")
  @@index([groupId, date], map: "idx_daily_messages_groupId_date")
  @@map("daily_messages")
}

model EvaluationWindow {
  id        String   @id @default(uuid())
  childId   String?
  startTime String
  endTime   String
  daysMask  String
  timezone  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  groupId   String?
  group     Group?   @relation(fields: [groupId], references: [id], onDelete: Cascade)
  child     User?    @relation(fields: [childId], references: [id])

  @@index([childId], map: "idx_evaluation_windows_childId")
  @@map("evaluation_windows")
}

model TaskAssignment {
  id                  String       @id @default(uuid())
  taskTemplateId      String
  childId             String
  startDate           DateTime
  endDate             DateTime?
  isActive            Boolean      @default(true)
  recurrence          String?
  recurrenceDays      String?
  recurrenceStartDate DateTime?
  recurrenceInterval  Int?
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
  child               User         @relation(fields: [childId], references: [id], onDelete: Cascade)
  taskTemplate        TaskTemplate @relation(fields: [taskTemplateId], references: [id], onDelete: Cascade)

  @@index([childId], map: "idx_task_assignments_childId")
  @@index([childId, isActive], map: "idx_task_assignments_childId_isActive")
  @@index([taskTemplateId], map: "idx_task_assignments_taskTemplateId")
  @@map("task_assignments")
}

model DaySubmission {
  id            String    @id @default(uuid())
  childId       String
  date          DateTime
  submittedAt   DateTime  @default(now())
  validatedAt   DateTime?
  parentComment String?
  pointsEarned  Int       @default(0) // Nouveau champ pour les points gagnés
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  child         User      @relation(fields: [childId], references: [id], onDelete: Cascade)

  @@unique([childId, date])
  @@index([childId, date], map: "idx_day_submissions_childId_date")
  @@index([validatedAt], map: "idx_day_submissions_validatedAt")
  @@index([pointsEarned], map: "idx_day_submissions_pointsEarned")
  @@map("day_submissions")
}

model Reward {
  id        String   @id @default(uuid())
  userId    String
  badgeType String
  earnedAt  DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "idx_rewards_userId")
  @@index([userId, earnedAt], map: "idx_rewards_userId_earnedAt")
  @@map("rewards")
}

model Book {
  id                 String              @id @default(uuid())
  groupId            String?
  googleBookId       String?
  title              String
  author             String?
  totalPages         Int
  isbn               String?
  coverImageUrl      String?
  language           String              @default("fr")
  genres             String[]             // Nouveaux genres
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  likes              BookLike[]
  reviews            BookReview[]
  group              Group?              @relation(fields: [groupId], references: [id], onDelete: Cascade)
  readingAssignments ReadingAssignment[]

  @@map("books")
}

model ReadingAssignment {
  id             String           @id @default(uuid())
  bookId         String
  childId        String
  assignedById   String?
  assignmentType String
  totalPoints    Int              @default(0)
  startDate      DateTime?
  dueDate        DateTime?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  assignedBy     User?            @relation("ReadingAssigner", fields: [assignedById], references: [id])
  book           Book             @relation(fields: [bookId], references: [id], onDelete: Cascade)
  child          User             @relation("ReadingChild", fields: [childId], references: [id], onDelete: Cascade)
  progress       ReadingProgress?

  @@map("reading_assignments")
}

model ReadingProgress {
  id                  String            @id @default(uuid())
  readingAssignmentId String            @unique
  currentPage         Int               @default(0)
  currentPoints       Int               @default(0)
  lastMilestone       Int               @default(0)
  isFinished          Boolean           @default(false)
  finishedAt          DateTime?
  lastPageUpdate      DateTime          @default(now())
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  readingAssignment   ReadingAssignment @relation(fields: [readingAssignmentId], references: [id], onDelete: Cascade)

  @@map("reading_progress")
}

model BookReview {
  id            String   @id @default(uuid())
  bookId        String
  reviewerId    String
  rating        Int
  comment       String?
  isChildReview Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  book          Book     @relation(fields: [bookId], references: [id], onDelete: Cascade)
  reviewer      User     @relation(fields: [reviewerId], references: [id], onDelete: Cascade)

  @@unique([bookId, reviewerId])
  @@map("book_reviews")
}

model BookLike {
  id        String   @id @default(uuid())
  bookId    String
  userId    String
  createdAt DateTime @default(now())
  book      Book     @relation(fields: [bookId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([bookId, userId])
  @@map("book_likes")
}

model BookTemplate {
  id            String   @id @default(uuid())
  title         String
  author        String
  totalPages    Int
  isbn          String?
  coverImageUrl String?
  language      String   @default("fr")
  genres        String[]
  googleBookId  String?  @unique
  synopsis      String?
  ageRange      Json?
  themes        String[]
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@map("book_templates")
}
